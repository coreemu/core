%define version @PACKAGE_VERSION@
%define lib_version @GENERIC_RELEASE@
%define python_version %(%{__python} -c "import sys; print '%s.%s' % (sys.version_info[0], sys.version_info[1])")%{nil}

%if 0%{?fedora} >= 17
%define with_kernel_modules_extra 1
%else
%define with_kernel_modules_extra 0
%endif

Name:		core
Summary:	Common Open Research Emulator for use with network namespaces
License:	BSD
Prefix:		/usr
Release:	1%{?dist}
Source:		core-%{version}.tar.gz
URL:		http://www.nrl.navy.mil/itd/ncs/products/core
Version:	%{version}
%description
The Common Open Research Emulator provides Python modules and a GUI for
building virtual networks using Linux network namespace containers and bridging.

%package daemon
Summary:	Common Open Research Emulator daemon back-end
Group:		System Tools
Requires:	bash bridge-utils ebtables iproute libev python net-tools
Requires:	python-enum34
%if 0%{?el6}
Requires: procps
%else
Requires: procps-ng
%endif
%if %{with_kernel_modules_extra}
Requires: kernel-modules-extra
%endif
%if 0%{?fedora} >= 25
Requires: iproute-tc
%endif
BuildRequires:	make automake autoconf libev-devel python-devel bridge-utils ebtables iproute net-tools ImageMagick help2man
BuildRequires:	python2-pytest-runner python2-sphinx
BuildRequires:	python-enum34
%if 0%{?el6}
BuildRequires: procps
%else
BuildRequires: procps-ng
%endif
%if 0%{?fedora} >= 25
BuildRequires: iproute-tc
%endif
Provides:	core-daemon
# python-sphinx
%description daemon
The Common Open Research Emulator provides Python modules for building virtual
networks using Linux network namespace containers and bridging.

%package gui
Summary:	Common Open Research Emulator GUI front-end
Group:		System Tools
Requires:	tcl tk xterm
BuildArch:	noarch
BuildRequires:  make automake autoconf
Provides:	core-gui
%description gui
The Common Open Research Emulator canvas-based Tcl/Tk GUI for easily drawing
virtual network topologies.

%prep

%setup -q

%build

./bootstrap.sh
# not using --disable-gui/--disable-daemon, because RPM expects both to be
# installed by this build process
# assume Fedora, using systemd startup script
CFLAGS="-fno-strict-aliasing $RPM_OPT_FLAGS" %configure --with-startup=systemd
make -j4

%install
rm -rf $RPM_BUILD_ROOT
make DESTDIR=$RPM_BUILD_ROOT install
rm -f $RPM_BUILD_ROOT/%{python_sitelib}/site.py* \
      $RPM_BUILD_ROOT/%{python_sitearch}/site.py* \
      $RPM_BUILD_ROOT/%{python_sitelib}/easy-install.pth \
      $RPM_BUILD_ROOT/%{python_sitearch}/easy-install.pth

%clean
rm -rf $RPM_BUILD_ROOT

%post

%post daemon
# don't run EMANE with realtime option under Fedora
sed -i 's/emane_realtime = True/emane_realtime = False/' /etc/core/core.conf

%preun daemon
if [ "$1" -eq 0 ]; then
    systemctl stop core-daemon.service > /dev/null 2>&1 || true

    if [ -x %{_bindir}/core-cleanup ]; then
        %{_bindir}/core-cleanup > /dev/null 2>&1 || true
    fi
fi

%postun

%files gui
%{_bindir}/core-gui
%dir @CORE_LIB_DIR@
@CORE_LIB_DIR@/*.tcl
%dir @CORE_LIB_DIR@/addons
@CORE_LIB_DIR@/addons/*
%{_datadir}/applications/*
%{_datadir}/pixmaps/*
%dir %{_datadir}/%{name}
%dir %{_datadir}/%{name}/icons
%dir %{_datadir}/%{name}/icons/normal
%{_datadir}/%{name}/icons/normal/*
%dir %{_datadir}/%{name}/icons/svg
%{_datadir}/%{name}/icons/svg/*
%dir %{_datadir}/%{name}/icons/tiny
%{_datadir}/%{name}/icons/tiny/*
%dir %{_datadir}/%{name}/examples
%dir %{_datadir}/%{name}/examples/configs
%{_datadir}/%{name}/examples/configs/*
%doc %{_mandir}/man1/core-gui.1.gz

%files daemon
%{_bindir}/core-cleanup
%{_bindir}/core-daemon
%{_bindir}/core-manage
%{_bindir}/coresendmsg
%{_bindir}/netns
%{_bindir}/vcmd
%{_bindir}/vnoded
%{python_sitelib}/*
%dir @CORE_CONF_DIR@
%config @CORE_CONF_DIR@/*
%{_sysconfdir}/systemd/system/core-daemon.service
%dir %{_datadir}/%{name}
%dir %{_datadir}/%{name}/examples
%{_datadir}/%{name}/examples/controlnet_updown
%{_datadir}/%{name}/examples/*.py*
%dir %{_datadir}/%{name}/examples/api
%{_datadir}/%{name}/examples/api/*
%dir %{_datadir}/%{name}/examples/hooks
%{_datadir}/%{name}/examples/hooks/*
%dir %{_datadir}/%{name}/examples/myemane
%{_datadir}/%{name}/examples/myemane/*
%dir %{_datadir}/%{name}/examples/myservices
%{_datadir}/%{name}/examples/myservices/*
%dir %{_datadir}/%{name}/examples/netns
%{_datadir}/%{name}/examples/netns/*
%dir %{_datadir}/%{name}/examples/services
%{_datadir}/%{name}/examples/services/*
%dir %{_datadir}/%{name}/examples/tdma
%{_datadir}/%{name}/examples/tdma/*
%dir %{_datadir}/corens3
%dir %{_datadir}/corens3/examples
%{_datadir}/corens3/examples/*
%doc %{_mandir}/man1/core-cleanup.1.gz
%doc %{_mandir}/man1/core-daemon.1.gz
%doc %{_mandir}/man1/core-manage.1.gz
%doc %{_mandir}/man1/coresendmsg.1.gz
%doc %{_mandir}/man1/core-xen-cleanup.1.gz
%doc %{_mandir}/man1/netns.1.gz
%doc %{_mandir}/man1/vcmd.1.gz
%doc %{_mandir}/man1/vnoded.1.gz

%changelog
* Fri May 25 2018 Gabriel Somlo <glsomlo@cert.org> - 5.1
- update RPM spec file to match 5.1 release
* Mon Nov 20 2017 Gabriel Somlo <glsomlo@cert.org> - 5.0
- update RPM spec file to match 5.0 release
* Fri Sep 01 2017 CORE Developers <core-dev@nrl.navy.mil> - 5.0
- Added Ryu SD and Open vSwitch services, code cleanup and refactoring
* Fri Jun 5 2015 CORE Developers <core-dev@pf.itd.nrl.navy.mil> - 4.8
- Support for NRL Network Modeling Framework (NMF) XML representation, bugfixes
* Wed Aug 6 2014 Jeff Ahrenholz <core-dev@pf.itd.nrl.navy.mil> - 4.7
- EMANE 0.9.1, asymmetric links, bugfixes
* Thu Aug 22 2013 Jeff Ahrenholz <jeffrey.m.ahrenholz@boeing.com> - 4.6
- cored now core-daemon, core now core-gui for CORE 4.6 release
* Wed Apr 3 2013 Jeff Ahrenholz <jeffrey.m.ahrenholz@boeing.com> - 4.5
- split into gui and daemon RPMs for CORE 4.5 release
* Tue Sep 4 2012 Jeff Ahrenholz <jeffrey.m.ahrenholz@boeing.com> - 4.4
- update files list for CORE 4.4 release, removed info file
* Tue Feb 7 2012 Jeff Ahrenholz <jeffrey.m.ahrenholz@boeing.com> - 4.3
- update files list for CORE 4.3 release, freshen dependencies
* Tue Aug 16 2011 Jeff Ahrenholz <jeffrey.m.ahrenholz@boeing.com> - 4.2
- update for CORE 4.2 release; use dir variables, more arch independent
* Mon Dec 13 2010 Jeff Ahrenholz <jeffrey.m.ahrenholz@boeing.com> - 4.1
- update for CORE 4.1 release; added calls to ldconfig and removal of pyc files
* Wed Aug 4 2010 Jeff Ahrenholz <jeffrey.m.ahrenholz@boeing.com> - 4.0
- update for CORE 4.0 release for Python and network namespaces
* Thu Sep 10 2009 Jeff Ahrenholz <jeffrey.m.ahrenholz@boeing.com> - 3.5
- update for CORE 3.5 release to include init script
* Fri May 29 2009 Jeff Ahrenholz <jeffrey.m.ahrenholz@boeing.com> - 3.4
- initial spec file for CORE 3.4 release

